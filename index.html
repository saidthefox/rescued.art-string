<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Date+Amount → Short IDs (8-char v1 & 10-char v2)</title>
  <style>
    :root { --gap: 14px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0 auto; padding: 24px; max-width: 820px; line-height: 1.5; }
    h1 { font-size: 1.35rem; margin: 0 0 6px 0; }
    p.note { color: #555; margin-top: 4px; }
    label { font-weight: 600; display:block; margin-top: var(--gap); }
    input, textarea, button, select { width: 100%; padding: 10px 12px; font-size: 1rem; border: 1px solid #ccc; border-radius: 8px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--gap); }
    .btn { margin-top: var(--gap); background: #0a7; border: 1px solid #0a7; color: white; cursor: pointer; }
    .btn.secondary { background: #555; border-color:#555; }
    .btn.muted { background:#888; border-color:#888; }
    .box { padding: 14px; border: 1px dashed #ccc; border-radius: 10px; background: #fafafa; }
    code, .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .muted { color:#666; font-size: .95rem; }
    footer { margin-top: 26px; color:#666; font-size: .85rem; }
    .ok { color: #0a7; font-weight: 600; }
    .err { color: #b00; font-weight: 600; }
    .pill { display:inline-block; padding:2px 8px; border-radius: 999px; background:#eef; color:#446; font-size:.85rem; }
  </style>
</head>
<body>
  <h1>Short IDs for Date + Amount — v1 (8 chars) & v2 (10 chars with variant)</h1>
  <p class="note">Both IDs are <strong>reversible, non-encrypted</strong>. v1 packs into 6 bytes → <strong>8 chars</strong>. v2 adds a 1‑byte <em>variant</em> so the same date+amount can map to many different outputs → 7 bytes → <strong>10 chars</strong>. Decoder accepts both.</p>

  <div class="box">
    <div class="row">
      <div>
        <label for="date">Date (YYYYMMDD)</label>
        <input id="date" placeholder="20250930" inputmode="numeric" maxlength="8" />
      </div>
      <div>
        <label for="amt">Amount (dollars.cents)</label>
        <input id="amt" placeholder="12.50" inputmode="decimal" />
      </div>
    </div>
    <div class="row3">
      <div>
        <label for="version">Version</label>
        <select id="version">
          <option value="v2" selected>v2 – 10 chars (with variant)</option>
          <option value="v1">v1 – 8 chars (legacy)</option>
        </select>
      </div>
      <div>
        <label for="variant">Variant (0–255)</label>
        <input id="variant" type="number" min="0" max="255" placeholder="random" />
      </div>
      <div>
        <label>Actions</label>
        <div class="row" style="grid-template-columns: 1fr 1fr; gap: 8px;">
          <button id="shuffle" class="btn muted" title="Set variant to a random value">Shuffle variant</button>
          <button id="makeBtn" class="btn">Make ID</button>
        </div>
      </div>
    </div>
    <label for="token">Generated ID (<span id="len">—</span>)</label>
    <input id="token" class="mono" readonly placeholder="Token appears here…" />
  </div>

  <div class="box" style="margin-top: var(--gap);">
    <div class="row">
      <div>
        <label for="tokenIn">Decode ID (8 or 10 chars)</label>
        <input id="tokenIn" class="mono" placeholder="Paste token here…" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="decodeBtn" class="btn secondary">Decode</button>
      </div>
    </div>
    <div id="out" class="muted" style="margin-top:10px;">No output yet.</div>
  </div>

  <p class="muted">Ranges (same for v1/v2): Year 0–16383, Month 1–12, Day 1–31, Amount 0–$335,544.31. v2 embeds a 0–255 <em>variant</em> to diversify outputs. No database required.</p>

  <footer>
    <div>Note: These are compact identifiers, not encryption. Use an encrypted token if you need secrecy.</div>
  </footer>

<script>
  // --- Base64url helpers (no padding) ---
  function b64UrlEncode(bytes) {
    let bin = '';
    for (let b of bytes) bin += String.fromCharCode(b);
    return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }
  function b64UrlDecode(s) {
    s = s.trim().replace(/-/g,'+').replace(/_/g,'/');
    while (s.length % 4) s += '=';
    const bin = atob(s);
    const arr = new Uint8Array(bin.length);
    for (let i=0;i<bin.length;i++) arr[i] = bin.charCodeAt(i);
    return arr;
  }

  // --- Pack YYYY/MM/DD + cents into 48 bits (6 bytes) ---
  function packDateAmount(yyyy, mm, dd, cents) {
    if (!(Number.isInteger(yyyy) && 0 <= yyyy && yyyy <= 16383)) throw new Error("Year out of range (0..16383)");
    if (!(Number.isInteger(mm) && 1 <= mm && mm <= 12)) throw new Error("Month must be 1..12");
    if (!(Number.isInteger(dd) && 1 <= dd && dd <= 31)) throw new Error("Day must be 1..31");
    if (!(Number.isInteger(cents) && 0 <= cents && cents <= ((1<<25)-1))) throw new Error("Amount too large (max 33,554,431 cents)");
    let v = BigInt(yyyy);
    v = (v << 34n) | (BigInt(mm) << 30n) | (BigInt(dd) << 25n) | BigInt(cents); // 14|4|5|25 = 48 bits
    const out = new Uint8Array(6);
    for (let i=5;i>=0;i--) { out[i] = Number(v & 0xFFn); v >>= 8n; }
    return out;
  }
  function unpackDateAmount(bytes6) {
    if (!(bytes6 instanceof Uint8Array) || bytes6.length !== 6) throw new Error("Need 6 bytes");
    let v = 0n;
    for (let i=0;i<6;i++) v = (v << 8n) | BigInt(bytes6[i]);
    const cents = Number(v & ((1n<<25n)-1n)); v >>= 25n;
    const day   = Number(v & ((1n<<5n)-1n));  v >>= 5n;
    const month = Number(v & ((1n<<4n)-1n));  v >>= 4n;
    const year  = Number(v & ((1n<<14n)-1n));
    return {year, month, day, cents};
  }

  // --- UI helpers ---
  function parseAmountToCents(s) {
    const m = String(s).trim().match(/^(\d+)(?:\.(\d{1,2}))?$/);
    if (!m) throw new Error("Amount must look like 12 or 12.34");
    const dollars = parseInt(m[1],10);
    const centsPart = m[2] ? m[2].padEnd(2,'0') : '00';
    return dollars*100 + parseInt(centsPart,10);
  }
  function randByte() { return Math.floor(Math.random()*256) & 0xFF; }

  // --- Encode (v1/v2) ---
  function encodeTokenV1(yyyy, mm, dd, cents) {
    const b6 = packDateAmount(yyyy, mm, dd, cents);
    return b64UrlEncode(b6); // 6 bytes -> 8 chars
  }
  function encodeTokenV2(yyyy, mm, dd, cents, variant /*0..255 or null*/) {
    const b6 = packDateAmount(yyyy, mm, dd, cents);
    const v = (variant == null || isNaN(variant)) ? randByte() : Math.max(0, Math.min(255, variant|0));
    const buf = new Uint8Array(7);
    buf[0] = v;          // variant byte
    buf.set(b6, 1);      // payload
    return { token: b64UrlEncode(buf), variant: v }; // 7 bytes -> 10 chars (unpadded)
  }

  // --- Decode (auto-detect) ---
  function decodeTokenAuto(token) {
    const clean = token.trim();
    const arr = b64UrlDecode(clean);
    if (clean.length === 8) {
      if (arr.length !== 6) throw new Error("Invalid v1 token bytes");
      const {year, month, day, cents} = unpackDateAmount(arr);
      return { version: 'v1', variant: null, year, month, day, cents };
    } else if (clean.length === 10) {
      if (arr.length !== 7) throw new Error("Invalid v2 token bytes");
      const variant = arr[0];
      const payload = arr.slice(1);
      const {year, month, day, cents} = unpackDateAmount(payload);
      return { version: 'v2', variant, year, month, day, cents };
    } else {
      throw new Error("Token length must be 8 (v1) or 10 (v2) characters");
    }
  }

  // --- Wire up UI ---
  const $ = (id) => document.getElementById(id);
  $('shuffle').addEventListener('click', () => { $('variant').value = String(randByte()); });
  $('makeBtn').addEventListener('click', () => {
    try {
      const d = $('date').value.trim();
      if (!/^\d{8}$/.test(d)) throw new Error("Date must be YYYYMMDD");
      const yyyy = parseInt(d.slice(0,4),10);
      const mm   = parseInt(d.slice(4,6),10);
      const dd   = parseInt(d.slice(6,8),10);
      const cents = parseAmountToCents($('amt').value);
      const ver = $('version').value;
      if (ver === 'v1') {
        const tok = encodeTokenV1(yyyy, mm, dd, cents);
        $('token').value = tok; $('len').textContent = tok.length + " chars (v1)";
      } else {
        const inputV = $('variant').value.trim();
        const v = inputV === "" ? null : Number(inputV);
        const { token, variant } = encodeTokenV2(yyyy, mm, dd, cents, v);
        $('token').value = token; $('len').textContent = token.length + " chars (v2, variant " + variant + ")";
        if (inputV === "") $('variant').value = String(variant);
      }
    } catch (e) {
      alert(e.message || String(e));
    }
  });

  $('decodeBtn').addEventListener('click', () => {
    const out = $('out');
    try {
      const tok = $('tokenIn').value.trim();
      const res = decodeTokenAuto(tok);
      const dollars = (res.cents/100).toFixed(2);
      const y = String(res.year).padStart(4,'0');
      const m = String(res.month).padStart(2,'0');
      const d = String(res.day).padStart(2,'0');
      let header = res.version === 'v2' ? `<span class="pill">v2 (variant ${res.variant})</span>` : `<span class="pill">v1</span>`;
      out.innerHTML = `${header}<br/>Date: <code>${y}${m}${d}</code><br/>Amount: <code>$${dollars}</code> (<code>${res.cents}</code> cents)`;
    } catch (e) {
      out.innerHTML = `<span class="err">Error:</span> ${e.message || String(e)}`;
    }
  });

  (function(){ const t = $('token').value; $('len').textContent = t ? (t.length + " chars") : "—"; })();
</script>
</body>
</html>
